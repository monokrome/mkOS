# mkOS dracut configuration

# Disable hostonly to prevent dracut from embedding cmdline.d parameters
# that conflict with UKI kernel command line (e.g., rootflags with subvolid)
hostonly="no"

# Omit all systemd dracut modules - mkOS targets non-systemd distributions
omit_dracutmodules+=" systemd systemd-initrd systemd-udevd dracut-systemd "
omit_dracutmodules+=" systemd-ac-power systemd-ask-password systemd-battery-check "
omit_dracutmodules+=" systemd-bsod systemd-coredump systemd-creds systemd-cryptsetup "
omit_dracutmodules+=" systemd-hostnamed systemd-integritysetup systemd-journald "
omit_dracutmodules+=" systemd-ldconfig systemd-modules-load systemd-network-management "
omit_dracutmodules+=" systemd-networkd systemd-pcrphase systemd-portabled systemd-pstore "
omit_dracutmodules+=" systemd-repart systemd-resolved systemd-sysctl systemd-sysext "
omit_dracutmodules+=" systemd-timedated systemd-timesyncd systemd-tmpfiles "
omit_dracutmodules+=" systemd-veritysetup systemd-emergency systemd-sysusers "

# Omit non-essential modules that fail without full udev/network stack
# mkOS uses mdevd and boots from local LUKS+btrfs only
omit_dracutmodules+=" network network-legacy network-manager "
omit_dracutmodules+=" cifs nfs nbd iscsi multipath brltty "

# Force modules that return 255 when not on running system
force_add_dracutmodules+=" dm crypt btrfs "

# Additional required modules
add_dracutmodules+=" rootfs-block "

# CPU microcode
early_microcode=yes

# Critical drivers for LUKS support
add_drivers+=" dm_mod dm_crypt "

# Drivers for VMs and common hardware
add_drivers+=" virtio virtio_blk virtio_pci virtio_scsi nvme ahci sd_mod "

# Filesystems
filesystems+=" btrfs ext4 vfat "

# Compression
compress="zstd"

# Include crypttab for LUKS device discovery
install_items+=" /etc/crypttab "
