#!/bin/bash
set -euo pipefail

# mkOS snapshot manager
# Usage:
#   mkos-snapshot create [name]  - Create a snapshot (default: timestamp)
#   mkos-snapshot list           - List all snapshots
#   mkos-snapshot rollback <name> - Rollback to a snapshot
#   mkos-snapshot delete <name>  - Delete a snapshot

SNAPSHOTS_DIR="/.snapshots"
ROOT_SUBVOL="/"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

cmd_create() {
    local name="${1:-$(date +%Y%m%d-%H%M%S)}"
    local snapshot_path="$SNAPSHOTS_DIR/$name"

    if [[ -d "$snapshot_path" ]]; then
        echo -e "${RED}Error: Snapshot '$name' already exists${NC}"
        exit 1
    fi

    echo -e "${GREEN}Creating snapshot: $name${NC}"
    btrfs subvolume snapshot -r "$ROOT_SUBVOL" "$snapshot_path"
    echo -e "${GREEN}Done: $snapshot_path${NC}"
}

cmd_list() {
    echo -e "${YELLOW}Available snapshots:${NC}"
    echo ""

    if [[ ! -d "$SNAPSHOTS_DIR" ]]; then
        echo "  (none)"
        return
    fi

    for snap in "$SNAPSHOTS_DIR"/*; do
        if btrfs subvolume show "$snap" &>/dev/null; then
            local name=$(basename "$snap")
            local created=$(btrfs subvolume show "$snap" | grep "Creation time" | cut -d: -f2-)
            printf "  %-20s %s\n" "$name" "$created"
        fi
    done
}

cmd_rollback() {
    local name="$1"
    local snapshot_path="$SNAPSHOTS_DIR/$name"

    if [[ ! -d "$snapshot_path" ]]; then
        echo -e "${RED}Error: Snapshot '$name' not found${NC}"
        cmd_list
        exit 1
    fi

    echo -e "${YELLOW}=== Rollback to '$name' ===${NC}"
    echo ""
    echo "This will:"
    echo "  1. Rename current @ to @.broken"
    echo "  2. Create writable snapshot from $name as new @"
    echo "  3. You'll need to reboot"
    echo ""
    echo -e "${RED}WARNING: Current system state will be saved as @.broken${NC}"
    echo ""
    read -p "Continue? [y/N] " confirm

    if [[ "${confirm,,}" != "y" ]]; then
        echo "Aborted."
        exit 1
    fi

    # Need to work from a different mount to manipulate @
    local work_mount=$(mktemp -d)
    local root_dev=$(findmnt -n -o SOURCE /)

    echo -e "${GREEN}[1/4] Mounting btrfs root...${NC}"
    mount -o subvolid=5 "$root_dev" "$work_mount"

    echo -e "${GREEN}[2/4] Moving current @ to @.broken...${NC}"
    if [[ -d "$work_mount/@.broken" ]]; then
        btrfs subvolume delete "$work_mount/@.broken"
    fi
    mv "$work_mount/@" "$work_mount/@.broken"

    echo -e "${GREEN}[3/4] Creating new @ from snapshot...${NC}"
    btrfs subvolume snapshot "$work_mount/.snapshots/$name" "$work_mount/@"

    echo -e "${GREEN}[4/4] Cleaning up...${NC}"
    umount "$work_mount"
    rmdir "$work_mount"

    echo ""
    echo -e "${GREEN}Rollback complete! Reboot to use the restored system.${NC}"
    echo ""
    echo "After reboot, if everything works, you can delete @.broken:"
    echo "  sudo btrfs subvolume delete /@.broken"
}

cmd_delete() {
    local name="$1"
    local snapshot_path="$SNAPSHOTS_DIR/$name"

    if [[ ! -d "$snapshot_path" ]]; then
        echo -e "${RED}Error: Snapshot '$name' not found${NC}"
        exit 1
    fi

    if [[ "$name" == "install" ]]; then
        echo -e "${YELLOW}Warning: 'install' is your pristine post-install snapshot${NC}"
        read -p "Really delete? [y/N] " confirm
        if [[ "${confirm,,}" != "y" ]]; then
            echo "Aborted."
            exit 1
        fi
    fi

    echo -e "${GREEN}Deleting snapshot: $name${NC}"
    btrfs subvolume delete "$snapshot_path"
    echo -e "${GREEN}Done${NC}"
}

# Main
case "${1:-help}" in
    create)
        cmd_create "${2:-}"
        ;;
    list|ls)
        cmd_list
        ;;
    rollback|restore)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: mkos-snapshot rollback <name>"
            exit 1
        fi
        cmd_rollback "$2"
        ;;
    delete|rm)
        if [[ -z "${2:-}" ]]; then
            echo "Usage: mkos-snapshot delete <name>"
            exit 1
        fi
        cmd_delete "$2"
        ;;
    *)
        echo "mkOS Snapshot Manager"
        echo ""
        echo "Usage:"
        echo "  mkos-snapshot create [name]   - Create snapshot (default: timestamp)"
        echo "  mkos-snapshot list            - List snapshots"
        echo "  mkos-snapshot rollback <name> - Rollback to snapshot"
        echo "  mkos-snapshot delete <name>   - Delete snapshot"
        ;;
esac
